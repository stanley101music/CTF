import glob
jpgs_enc = (glob.glob('./*.jpg_encrypted'))
enc = []
for jpg_enc in jpgs_enc:
    f = open(jpg_enc, 'rb')
    enc.append(f.read())
    f.close()
f = open('./flag.txt_encrypted', 'rb')
flag_enc = f.read()
f.close()

JPEG_sig = [0xFF, 0xD8, 0xFF, 0xE0, None, None, 0x4A, 0x46, 0x49, 0x46, 0x00, 0x01, 0x02]
JPEG_trailer = [0xFF, 0xD9]

key = [None] * 0x20
flag_truth = ['F', 'L', 'A', 'G', '{', '}']
for i in range(5):
    key[i] = flag_enc[i] ^ ord(flag_truth[i])
key[-1] = flag_enc[-1] ^ ord(flag_truth[-1])

for i in range(len(JPEG_sig)):
    if JPEG_sig[i]:
        key[i] = enc[0][i] ^ JPEG_sig[i]

for cipher in enc:
    off1, off2 = (len(cipher)-2) % 0x20, (len(cipher)-1) % 0x20
    if key[off1]:
        assert key[off1] == cipher[-2]^JPEG_trailer[-2]
    if key[off2]:
        assert key[off2] == cipher[-1]^JPEG_trailer[-1]
    key[off1], key[off2] = cipher[-2] ^ JPEG_trailer[-2], cipher[-1] ^ JPEG_trailer[-1]
flag = ""
# The first 5 bytes of flag is "FLAG{"
for i in range(len(flag_enc)):
    if key[i%0x20] == None:
        flag += '.'
        continue
    flag += chr(key[i%0x20] ^ flag_enc[i])
print(flag)
# Currently we got FLAG{.OR-MAKE.....WN-PLA..TE.T-ÃND-FR.QUENCY-.....SIS-EA..}
# Dot is for unknown
## -FR.QUENCY- The dot must be E for FREQUENCY, so we get one more key
key[37%0x20] = flag_enc[37] ^ ord('E')
flag = ""
for i in range(len(flag_enc)):
    if key[i%0x20] == None:
        flag += '.'
        continue
    flag += chr(key[i%0x20] ^ flag_enc[i])
print(flag)
# FLAG{XOR-MAKE.....WN-PLA..TE.T-ÃND-FREQUENCY-.....SIS-EA..}
# PLA..TE.T -> PLAINTEXT (https://wordfinder.yourdictionary.com/letter-words/9-starts-pla-with-te-ends-t/)
key[24%0x20] = flag_enc[24] ^ ord('I')
key[25%0x20] = flag_enc[25] ^ ord('N')
key[28%0x20] = flag_enc[28] ^ ord('X')
flag = ""
for i in range(len(flag_enc)):
    if key[i%0x20] == None:
        flag += '.'
        continue
    flag += chr(key[i%0x20] ^ flag_enc[i])
print(flag)
# FLAG{XOR-MAKE.....WN-PLAINTEXT-ÃND-FREQUENCY-.....SIS-EASY}
# .....SIS -> ANALYSIS
key[45%0x20] = flag_enc[45] ^ ord('A')
key[46%0x20] = flag_enc[46] ^ ord('N')
key[47%0x20] = flag_enc[47] ^ ord('A')
key[48%0x20] = flag_enc[48] ^ ord('L')
key[49%0x20] = flag_enc[49] ^ ord('Y')
flag = ""
for i in range(len(flag_enc)):
    if key[i%0x20] == None:
        flag += '.'
        continue
    flag += chr(key[i%0x20] ^ flag_enc[i])
print(flag)
# FLAG{XOR-MAKES-KNOWN-PLAINTEXT-ÃND-FREQUENCY-ANALYSIS-EASY}
# Take care of the "Ã", which is not "A"
# But in this situation, it's clearly that the flag is FLAG{XOR-MAKES-KNOWN-PLAINTEXT-AND-FREQUENCY-ANALYSIS-EASY}